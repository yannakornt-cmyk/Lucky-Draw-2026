<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gift Exchange 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        .bg-festive {
            background-color: #d32f2f; /* Red */
            background-image: radial-gradient(#ef5350 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-festive min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden border-4 border-yellow-400 relative">
        
        <div class="bg-green-700 p-6 text-center text-white">
            <h1 class="text-3xl font-bold">üéÅ ‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</h1>
            <p class="text-green-100 text-sm mt-1">Gift Exchange Party</p>
        </div>

        <div id="app" class="p-6 min-h-[300px] flex flex-col items-center justify-center">
            <div id="loading" class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-700 mx-auto"></div>
                <p class="mt-4 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>

        <div class="bg-gray-50 p-3 text-center text-xs text-gray-400">
            Powered by GAS & LINE LIFF
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2008897166-JAm3SznE"; 
        const API_URL = "https://script.google.com/a/macros/chula.ac.th/s/AKfycbyQ-hdDQAVHjP_s-_ZTbBqNJAziSXsXKUBApMjOhy2YnJfL02Juvd50R47olUuL7j93dA/exec"; // Ends in /exec

        let userProfile = null;

        // --- MAIN LOGIC ---
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                userProfile = await liff.getProfile();
                checkUserStatus();

            } catch (err) {
                Swal.fire('Error', 'Failed to initialize LIFF: ' + err.message, 'error');
            }
        }

        // --- API & ACTIONS ---

        // 1. Check Status
        async function checkUserStatus() {
            showLoading(true);
            try {
                const response = await callApi('checkUser', { userId: userProfile.userId });
                showLoading(false);
                
                if (response.state === 'not_registered') {
                    renderRegister();
                } else if (response.state === 'registered_not_drawn') {
                    renderDraw();
                } else if (response.state === 'completed') {
                    renderResult(response.result);
                }

            } catch (err) {
                showLoading(false);
                Swal.fire('Error', 'Connection failed', 'error');
            }
        }

        // 2. Register
        async function handleRegister() {
            const giftDesc = document.getElementById('giftInput').value;
            if (!giftDesc) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'warning');
                return;
            }

            // Confirm before submit
            const confirm = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
                text: `‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠: ${giftDesc}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'
            });

            if (confirm.isConfirmed) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const res = await callApi('register', {
                    userId: userProfile.userId,
                    displayName: userProfile.displayName,
                    giftDetails: giftDesc
                });

                if (res.status === 'success') {
                    await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
                    renderDraw(); // Move to next state
                } else {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
                }
            }
        }

        // 3. Draw Gift
        async function handleDraw() {
            const confirm = await Swal.fire({
                title: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏´‡∏°?',
                text: "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô'
            });

            if (confirm.isConfirmed) {
                // Show fancy animation or loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç...',
                    html: '‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ! üéÅ',
                    timerProgressBar: true,
                    didOpen: () => Swal.showLoading()
                });

                const res = await callApi('drawGift', {
                    userId: userProfile.userId,
                    displayName: userProfile.displayName
                });

                if (res.status === 'success') {
                    await Swal.fire({
                        title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!',
                        text: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏à‡∏≤‡∏Å ${res.result.receiverName}`,
                        icon: 'success',
                        backdrop: `rgba(0,0,123,0.4) url("https://media.giphy.com/media/26tOZ42MgWX5Im5Ww/giphy.gif") left top no-repeat`
                    });
                    renderResult(res.result);
                } else {
                    Swal.fire('Oops...', res.message, 'error');
                }
            }
        }

        // --- HELPER: API CALLER ---
        async function callApi(action, payload) {
            const body = { action, ...payload };
            const response = await fetch(API_URL, {
                method: 'POST',
                mode: 'cors', // Crucial for external hosting
                body: JSON.stringify(body)
            });
            return await response.json();
        }

        // --- RENDER FUNCTIONS ---

        function renderRegister() {
            const html = `
                <div class="w-full animate-fade-in text-center">
                    <img src="${userProfile.pictureUrl}" class="w-20 h-20 rounded-full mx-auto border-4 border-yellow-400 shadow-md mb-4">
                    <h2 class="text-xl font-bold text-gray-800">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${userProfile.displayName}</h2>
                    <p class="text-gray-500 mb-6">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å</p>
                    
                    <div class="mb-4 text-left">
                        <label class="block text-gray-700 text-sm font-bold mb-2">‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏≥‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠?</label>
                        <input id="giftInput" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£ Starbucks 500 ‡∏ö‡∏≤‡∏ó" 
                            class="shadow appearance-none border rounded w-full py-3 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <button onclick="handleRegister()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-105">
                        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        function renderDraw() {
            const html = `
                <div class="w-full animate-fade-in text-center">
                    <div class="text-6xl mb-4">üéÅ</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!</h2>
                    <p class="text-gray-600 mb-8">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</p>
                    
                    <button onclick="handleDraw()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg transition transform hover:scale-105 text-lg">
                        üé≤ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        function renderResult(data) {
            const html = `
                <div class="w-full animate-fade-in text-center p-4 border-2 border-dashed border-yellow-500 rounded-xl bg-yellow-50">
                    <h3 class="text-gray-500 font-bold uppercase tracking-wide text-sm mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</h3>
                    
                    <div class="text-3xl font-bold text-red-600 mb-1">
                        "${data.giftDetails}"
                    </div>
                    
                    <div class="my-4 border-b border-gray-300 w-1/2 mx-auto"></div>
                    
                    <p class="text-gray-600 text-sm">‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì</p>
                    <div class="text-xl font-bold text-green-700">
                        ${data.receiverName}
                    </div>
                </div>
                <div class="mt-6 text-center text-gray-400 text-sm">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ô‡∏∞!
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        function showLoading(isLoading) {
            const el = document.getElementById('loading');
            el.style.display = isLoading ? 'block' : 'none';
        }

        // Start
        main();

    </script>
</body>
</html>
