<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Draw: Gift Exchange</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Prompt', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-red-500 to-red-800 min-h-screen flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-md rounded-2xl shadow-2xl p-6 text-center space-y-6">
        
        <div>
            <h1 class="text-3xl font-bold text-red-700">üéÅ Gift Exchange</h1>
            <p class="text-gray-600 text-sm mt-1">‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</p>
        </div>

        <div id="loading" class="flex flex-col items-center py-10">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p class="text-gray-500 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="main-content" class="hidden space-y-6">
            
            <div class="flex flex-col items-center">
                <img id="user-img" src="" alt="Profile" class="w-24 h-24 rounded-full border-4 border-white shadow-lg object-cover">
                <h2 id="user-name" class="text-xl font-semibold text-gray-800 mt-3"></h2>
                <span id="user-status" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-600 mt-1">Guest</span>
            </div>

            <div id="action-area" class="pt-4">
                </div>

        </div>

        <div class="text-xs text-gray-400 mt-8">
            Created for Gift Exchange Event
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2008897166-JAm3SznE"; // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const GAS_ENDPOINT = "https://script.google.com/a/macros/chula.ac.th/s/AKfycbyQ-hdDQAVHjP_s-_ZTbBqNJAziSXsXKUBApMjOhy2YnJfL02Juvd50R47olUuL7j93dA/exec"; // ‡πÉ‡∏™‡πà URL Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Deploy

        // Global User Data
        let userProfile = {};

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                userProfile = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                };

                // Setup UI with Profile
                document.getElementById('user-img').src = userProfile.pictureUrl;
                document.getElementById('user-name').innerText = userProfile.displayName;
                
                // Check Registration Status
                await checkUserStatus();

            } catch (error) {
                console.error('LIFF Init Error', error);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function checkUserStatus() {
            showLoading(true);
            try {
                const response = await fetch(GAS_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'check_register',
                        user_id: userProfile.userId
                    })
                });
                const data = await response.json();
                
                renderInterface(data);

            } catch (error) {
                console.error(error);
                Swal.fire('Connection Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderInterface(data) {
            const actionArea = document.getElementById('action-area');
            const statusBadge = document.getElementById('user-status');
            actionArea.innerHTML = ''; // Clear existing

            if (!data.is_registered) {
                // CASE 1: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                statusBadge.className = "text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 mt-1";
                statusBadge.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
                
                const btn = document.createElement('button');
                btn.className = "w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition hover:scale-105";
                btn.innerHTML = "üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°";
                btn.onclick = handleRegister;
                actionArea.appendChild(btn);

            } else {
                // CASE 2: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏à‡∏≤‡∏Å Logic ‡∏ù‡∏±‡πà‡∏á Server)
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏ï‡πà Server ‡∏à‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                
                statusBadge.className = "text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 mt-1";
                statusBadge.innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß";

                const btn = document.createElement('button');
                btn.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg text-lg transform transition hover:scale-105 flex items-center justify-center gap-2";
                btn.innerHTML = "üé≤ ‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÄ‡∏•‡∏¢!";
                btn.onclick = handleDraw;
                actionArea.appendChild(btn);
            }
        }

        async function handleRegister() {
            // Confirm Dialog ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô?',
                text: `‡∏Ñ‡∏∏‡∏ì ${userProfile.displayName} ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                imageUrl: userProfile.pictureUrl,
                imageWidth: 100,
                imageHeight: 100,
                imageAlt: 'Custom image',
                showCancelButton: true,
                confirmButtonColor: '#10B981', // Green
                cancelButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                customClass: {
                    image: 'rounded-full border-4 border-gray-200'
                }
            });

            if (result.isConfirmed) {
                showLoading(true);
                try {
                    const response = await fetch(GAS_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'register',
                            user_id: userProfile.userId,
                            display_name: userProfile.displayName,
                            picture_url: userProfile.pictureUrl
                        })
                    });
                    const resData = await response.json();
                    
                    if(resData.status === 'success') {
                        // ‡πÅ‡∏™‡∏î‡∏á Alert ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
                        await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        
                        // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
                        window.location.reload(); 
                    } else {
                        Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', resData.message, 'warning');
                        showLoading(false); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î loading ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
                    }

                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    showLoading(false);
                }
                // ‡∏ï‡∏±‡∏î finally ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ loading ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞ refresh (‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
            }
        }

        async function handleDraw() {
            // Draw Confirmation
            const confirmDraw = await Swal.fire({
                title: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏´‡∏°?',
                text: "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#DC2626', // Red
                confirmButtonText: '‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å!',
                cancelButtonText: '‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô'
            });

            if (confirmDraw.isConfirmed) {
                showLoading(true);
                try {
                    const response = await fetch(GAS_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'draw',
                            drawer_id: userProfile.userId,
                            drawer_name: userProfile.displayName
                        })
                    });
                    const resData = await response.json();

                    if(resData.status === 'success') {
                        // Success Animation & Result
                        Swal.fire({
                            title: 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! üéâ',
                            html: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏à‡∏≤‡∏Å:<br/><br/>
                                   <b style="font-size: 1.5em; color: #DC2626;">${resData.data.gift_owner_name}</b>`,
                            icon: 'success',
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                            backdrop: `
                                rgba(0,0,123,0.4)
                                url("https://media.giphy.com/media/uWDwD6y7lYg6z6J5X7/giphy.gif")
                                left top
                                no-repeat
                            `
                        });
                        // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Draw ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                        document.getElementById('action-area').innerHTML = `<div class="p-4 bg-gray-100 rounded-lg text-gray-600">‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏à‡∏≤‡∏Å <b>${resData.data.gift_owner_name}</b> ‡πÅ‡∏•‡πâ‡∏ß</div>`;
                    } else {
                        Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', resData.message, 'error');
                    }

                } catch (err) {
                    Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å', 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        function showLoading(isLoading) {
            const loader = document.getElementById('loading');
            const content = document.getElementById('main-content');
            if (isLoading) {
                loader.classList.remove('hidden');
                content.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                content.classList.remove('hidden');
            }
        }

        // Start App
        main();

    </script>
</body>
</html>
