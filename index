<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Year Lucky Draw 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <style>
    body { font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%); min-height: 100vh; }
    .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    .animate-bounce-slow { animation: bounce 2s infinite; }
  </style>
</head>
<body class="flex items-center justify-center p-4">

  <div class="w-full max-w-md bg-white rounded-3xl card-shadow overflow-hidden relative min-h-[500px] flex flex-col">
     <div id="loading" class="flex flex-col items-center justify-center h-full p-10">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-pink-500 mb-4"></div>
        <p class="text-gray-500">Connecting...</p>
     </div>
     </div>

  <script>
    // --- CONFIGURATION ---
    const LIFF_ID = 'YOUR_LIFF_ID_HERE'; 
    const API_URL = 'https://script.google.com/macros/s/xxxxxxxxx/exec'; // เอา URL จาก GAS มาวางที่นี่

    let userProfile = {};

    window.onload = async function() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        const profile = await liff.getProfile();
        userProfile = {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl
        };
        callApi('checkStatus', { lineUserId: userProfile.userId });
      }
    };

    // --- ฟังก์ชันหลักในการยิง API แทน google.script.run ---
    async function callApi(action, payload = {}) {
      // payload ต้องมี action
      const data = { action: action, ...payload };
      
      try {
        // fetch ไปยัง Google Script (Post request)
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const res = await response.json();
        
        // Router จัดการผลลัพธ์
        if (action === 'checkStatus') onStatusChecked(res);
        if (action === 'register') onRegisterResult(res);
        if (action === 'draw') onDrawResult(res);
        
      } catch (err) {
        Swal.fire('Error', 'Connection failed: ' + err, 'error');
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // --- CALLBACK HANDLERS ---

    function onStatusChecked(response) {
      document.getElementById('loading').classList.add('hidden');
      if (response.status === 'NOT_REGISTERED') {
        // Setup UI for Register
        // document.getElementById('regDisplayName').innerText = userProfile.displayName; ...
        // document.getElementById('registerView').classList.remove('hidden');
      } else if (response.status === 'READY_TO_DRAW') {
        // document.getElementById('drawView').classList.remove('hidden');
      } else if (response.status === 'ALREADY_DRAWN') {
        // showResult(response.result.giverName);
      }
      // หมายเหตุ: คุณต้องไป Copy โค้ดจัดการ DOM (getElementById...) จากคำตอบก่อนหน้ามาใส่ตรงนี้นะครับ
    }

    function handleRegister() {
       // ... Swal logic ...
       // เปลี่ยนจาก google.script.run เป็น:
       showLoading();
       callApi('register', { profile: userProfile });
    }

    function onRegisterResult(res) {
        if(res.success) {
            Swal.fire('สำเร็จ', 'ลงทะเบียนเรียบร้อย!', 'success').then(() => location.reload());
        } else {
            Swal.fire('แจ้งเตือน', res.message, 'warning');
        }
    }

    function handleDraw() {
        // ... Swal logic ...
        // เปลี่ยนจาก google.script.run เป็น:
        showLoadingAlert();
        callApi('draw', { lineUserId: userProfile.userId, displayName: userProfile.displayName });
    }

    function onDrawResult(res) {
        if (res.success) {
            // Success Logic
            // showResult(res.giverName);
        } else {
            Swal.fire('ขออภัย', res.message, 'error');
        }
    }

    // ... Helper functions (showResult, showLoading) เหมือนเดิม ...
  </script>
</body>
</html>
